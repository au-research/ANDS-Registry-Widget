/*
 *  ANDS-Registry-Widget - v0.0.1
 *  A Widget to display and search for ANDS Registry contents
 *  https://developers.ands.org.au/
 *
 *  Made by Minh Duc Nguyen
 *  Under MIT License
 */
!function(a,b,c,d){"use strict";function e(b,c){this.element=b,this.settings=a.extend({},h,c),this._defaults=h,this.params=i,this._name=g,this.init()}function f(b){return{lookup:function(a){return this.get(b.apiUrl,a).then(function(a){return a})},get:function(b,c){return a.ajax({dataType:"jsonp",url:b,data:c}).then(function(a){return a})}}}var g="registryWidget",h={mode:"display-grant",apiUrl:"",serviceUrl:"http://devl.ands.org.au/minh/api/",renderEngine:"default"},i={apiKey:"public"};a.extend(e.prototype,{init:function(){this.setParams(),this.service=new f(this.settings);var b=a(this.element),c=this;switch("object"==typeof Mustache&&(this.settings.renderEngine="mustache"),this.settings.mode){case"display-grant":c.lookupAndDisplay(b,"display-grant-tpl");break;case"lookup-grant":this.bindLookup(b);break;case"search-grant":this.bindSearch(b),this.bindLookup(b)}},bindLookup:function(b){var c,d=this;c=a(b).next(".display-target").length>0?a(b).next(".display-target")[0]:a("<div class='display-target'/>").insertAfter(b),d.lookup(b,c),a(b).on("blur",function(){d.lookup(b,c)}),a(b).on("keyup",function(){e(function(){d.lookup(b,c)},1e3)});var e=function(){var a=0;return function(b,c){clearTimeout(a),a=setTimeout(b,c)}}()},bindSearch:function(b){var c,d=this;if(a(b).next(".search-toggle").length>0)c=a(b).next(".search-toggle")[0];else{var e="<a href='javascript:;' class='search-toggle'>Open Search</a>";c=a(e).insertAfter(b)}var f;if(a(c).next(".search-container").length>0)f=a(c).next(".search-container")[0];else{var e="<div class='search-container'></div>";f=a(e).insertAfter(c)}f.hide();var g={};this.settings.searchOptions&&this.settings.searchOptions.facets&&(g.facets=this.settings.searchOptions.facets);var h=[{value:"q",display:"All"},{value:"title",display:"Title"},{value:"description",display:"Description"},{value:"person",display:"Person"},{value:"id",display:"Identifier"}];g.searchQueryOption=h,g.activeQueryOptionDisplay="All",g.activeQueryOptionValue="q",this.render(f,g,"search-tpl"),c.on("click",function(){f.toggle()});var i=a(".search-query",f),j=a(".search-button",f),k=a(".search-result",f);this.settings.searchOptions&&this.settings.searchOptions.autoSearch&&(d.search(k),f.show()),i.on("keyup",function(a){13==a.which&&d.search(k)}),j.on("click",function(){d.search(k)}),a(".select-query-option").on("click",function(){var b=a(this),c=b.data("value"),e=b.val(),g="";a.each(h,function(){delete d.params[this.value],this.value==c&&(g=this.display)}),d.params[c]=e,a(".active-query-option",f).attr("data-value",c).html(g)}),a(k).on("click",".search-result-item",function(){a(b).val(a(this).data("purl")),a(f).hide(),a(b).blur()}),a(k).on("change",".facet-select",function(){var b=a(this).data("param");d.params[b]=a(this).val(),d.search(k)}),a(k).on("click",".show-more",function(){var a;a=d.params.pp?d.params.pp:30,d.params.rows=d.params.rows?d.params.rows+a:30+a,d.search(k)})},lookup:function(b,c){var d=this;""!=a(b).val()&&d.params.purl!=a(b).val()&&(d.params.purl=a(b).val(),d.lookupAndDisplay(c,"display-grant-tpl"))},search:function(b){var c=this;delete c.params.purl;var e=a(c.element).nextAll(".search-container"),f=a(".search-query",e),g=a(".active-query-option",e).attr("data-value");""!=g&&g!==d||(g="q"),c.params[g]=f.val(),c.lookupAndDisplay(b,"search-result-tpl")},getSearchOption:function(a){return this.settings.searchOptions&&this.settings.searchOptions[a]?this.settings.searchOptions[a]:!1},lookupAndDisplay:function(b,c){var d=this;""==a(b).text()&&a(b).text("Loading..."),d.getSearchOption("facets")!==!1&&(d.params.facets=d.getSearchOption("facets").join()),d.service.lookup(d.params).done(function(a){d.event("search-complete",a),d.render(b,a,c)})},setParams:function(){this.settings.mode.indexOf("grant")>-1&&(this.settings.apiUrl=this.settings.serviceUrl+"v2.0/registry.jsonp/grants"),this.settings.apiKey&&(this.params.apiKey=this.settings.apiKey),this.params=a.extend({},this.params,a(this.element).data()),this.getSearchOption("params")&&(this.params=a.extend({},this.params,this.getSearchOption("params")))},render:function(b,c,d){var e=this;"default"==this.settings.renderEngine?a(b).text(JSON.stringify(c)):"mustache"==this.settings.renderEngine?(d=e.getTemplate(d),c.numFound&&c.totalFound&&(c.more=c.numFound<c.totalFound),c.facets&&a.each(c.facets,function(a,b){c[a+"_facet"]=b,c["hasfacet_"+a]=!0}),a(b).html(Mustache.render(d,c)),a.each(a("select",b),function(){var b=a(this).data("param");e.params[b]&&a(this).val(e.params[b])})):e.event("error","No rendering engine found"),e.event("render-complete",[b,c,d])},event:function(b,c){var d="ands.registry-widget.";a(this.element).trigger(d+b,c)},getTemplate:function(b){var c="No template found!",d=a("#"+b);return d.length>0?c=d.html():m[b]&&(c=m[b]),c}}),a.fn[g]=function(b){return this.each(function(){a.data(this,"plugin_"+g)||a.data(this,"plugin_"+g,new e(this,b))})};var j='<div class="well">';j+="        {{ #recordData }}",j+="        <h4>{{title}}</h4>",j+="        <dl>",j+="            {{ #purl }}",j+="            <dt>PURL</dt>",j+="            <dd>{{ purl }}</dd>",j+="            {{ /purl }}",j+="            {{ #institutions }}",j+="            <dt>Institutions</dt>",j+="            <dd>{{ institutions }}</dd>",j+="            {{ /institutions }}",j+="            {{ #funder }}",j+="            <dt>Funder</dt>",j+="            <dd>{{ funder }}</dd>",j+="            {{ /funder }}",j+="            {{ #fundingScheme }}",j+="            <dt>Funding Scheme</dt>",j+="            <dd>{{ fundingScheme }}</dd>",j+="            {{ /fundingScheme }}",j+="            {{ #researchers }}",j+="            <dt>Researcher</dt>",j+="            <dd>{{ researchers }}</dd>",j+="            {{ /researchers }}",j+="        </dl>",j+="        {{ description }}",j+="        {{ /recordData }}",j+="        {{ ^recordData }}",j+="        <p>No result found!</p>",j+="        {{ /recordData}}",j+="    </div>";var k='<div class="well">';k+='    <div class="form-group">',k+='        <label for="lookup-grant">Search Query</label>',k+="",k+='        <div class="input-group">',k+='            <span class="input-group-btn">',k+='                <div class="btn-group">',k+='                    <button type="button"',k+='class="btn btn-default dropdown-toggle btn-select-query-option"',k+='data-toggle="dropdown" aria-haspopup="true"',k+='                            aria-expanded="false">',k+='                        <span class="value active-query-option"',k+='                              data-value="{{ activeQueryOptionValue }}">',k+="                            {{ activeQueryOptionDisplay }}",k+="                        </span>",k+='                        <span class="caret"></span>',k+="                    </button>",k+='                    <ul class="dropdown-menu">',k+="                        {{ #search_query_options }}",k+='                            <li><a href="javascript:;"',k+='                   class="select-query-option"',k+='                   data-value="{{ value }}">{{ display }}</a></li>',k+="                        {{ /search_query_options }}",k+="                    </ul>",k+="                </div>",k+="            </span>",k+='            <input type="text" class="form-control search-query"',k+='                   placeholder="Search Query"',k+='                   value="{{ searchQuery }}"/>',k+='            <span class="input-group-btn">',k+='                <a href="javascript:;"',k+='                   class="btn btn-default search-button">Search</a>',k+="            </span>",k+="        </div>",k+="    </div>",k+='    <div class="search-result"></div>',k+="</div>";var l="{{ #hasfacet_administering_institution }}";l+='<div class="form-group">',l+='    <label for="">Institutions</label>',l+='    <select class="form-control facet-select" data-param="institution">',l+='        <option value=""></option>',l+="        {{ #administering_institution_facet }}",l+='        <option value="{{ key }}">{{ key }}</option>',l+="        {{ /administering_institution_facet }}",l+="    </select>",l+="</div>",l+="{{ /hasfacet_administering_institution }}",l+="",l+="{{ #hasfacet_funders }}",l+='<div class="form-group">',l+='    <label for="">Funders</label>',l+='    <select class="form-control facet-select" data-param="funder">',l+='        <option value=""></option>',l+="        {{ #funders_facet }}",l+='        <option value="{{ key }}">{{ key }}</option>',l+="        {{ /funders_facet }}",l+="    </select>",l+="</div>",l+="{{ /hasfacet_funders }}",l+="",l+="{{ #hasfacet_type }}",l+='<div class="form-group">',l+='    <label for="">Type</label>',l+='    <select class="form-control facet-select" data-param="type">',l+='        <option value=""></option>',l+="        {{ #type_facet }}",l+='        <option value="{{ key }}">{{ key }}</option>',l+="        {{ /type_facet }}",l+="    </select>",l+="</div>",l+="{{ /hasfacet_type }}",l+="",l+="{{ #hasfacet_funding_scheme }}",l+='<div class="form-group">',l+='    <label for="">Funding Scheme</label>',l+='    <select class="form-control facet-select" data-param="fundingScheme">',l+='        <option value=""></option>',l+="        {{ #funding_scheme_facet }}",l+='        <option value="{{ key }}">{{ key }}</option>',l+="        {{ /funding_scheme_facet }}",l+="    </select>",l+="</div>",l+="{{ /hasfacet_funding_scheme }}",l+="",l+="<ul>",l+="    {{ #recordData }}",l+="    <li>",l+='        <a href="javascript:;"',l+='           class="search-result-item"',l+='           data-purl="{{ purl }}"',l+="        >",l+="            {{ title }}",l+="        </a>",l+="    </li>",l+="    {{ /recordData }}",l+="</ul>",l+="",l+="<p>Displaying ({{ numFound }}/{{ totalFound }}) results</p>",l+="{{ #more }}",l+='<a href="javascript:;" class="show-more">Show More</a>',l+="{{ /more }}",l+="",l+="",l+="{{ ^recordData }}",l+="<p>No result found!</p>",l+="{{ /recordData }}";var m={"display-grant-tpl":j,"search-tpl":k,"search-result-tpl":l}}(jQuery,window,document);