/*
 *  ANDS-Registry-Widget - v0.0.1
 *  A Widget to display and search for ANDS Registry contents
 *  https://developers.ands.org.au/
 *
 *  Made by Minh Duc Nguyen
 *  Under MIT License
 */
defaultTemplates=function(a,b,c,d){"use strict";var e='<div class="well">';e+="        {{ #records }}",e+="        <h4>{{title}}</h4>",e+="        <dl>",e+="            {{ #purl }}",e+="            <dt>PURL</dt>",e+="            <dd>{{ purl }}</dd>",e+="            {{ /purl }}",e+="            {{ #institutions.length }}",e+="            <dt>Institutions</dt>",e+="            <dd>{{ institutions }}</dd>",e+="            {{ /institutions.length }}",e+="            {{ #funder }}",e+="            <dt>Funder</dt>",e+="            <dd>{{ funder }}</dd>",e+="            {{ /funder }}",e+="            {{ #fundingScheme }}",e+="            <dt>Funding Scheme</dt>",e+="            <dd>{{ fundingScheme }}</dd>",e+="            {{ /fundingScheme }}",e+="            {{ #researchers.length }}",e+="            <dt>Researchers</dt>",e+="            <dd>{{ researchers }}</dd>",e+="            {{ /researchers.length }}",e+="        </dl>",e+="        {{ description }}",e+="        {{ /records }}",e+="        {{ ^records }}",e+="        <p>No result found!</p>",e+="        {{ /records}}",e+="    </div>";var f='<div class="well">';f+='    <div class="form-group">',f+='        <label for="lookup-grant">Search Query</label>',f+="",f+='        <div class="input-group">',f+='            <span class="input-group-btn">',f+='                <div class="btn-group">',f+='                    <button type="button"',f+='class="btn btn-default dropdown-toggle btn-select-query-option"',f+='data-toggle="dropdown" aria-haspopup="true"',f+='                            aria-expanded="false">',f+='                        <span class="value active-query-option"',f+='                              data-value="{{ activeQueryOptionValue }}">',f+="                            {{ activeQueryOptionDisplay }}",f+="                        </span>",f+='                        <span class="caret"></span>',f+="                    </button>",f+='                    <ul class="dropdown-menu">',f+="                        {{ #searchQueryOptions }}",f+='                            <li><a href="javascript:;"',f+='                   class="select-query-option"',f+='                   data-value="{{ value }}">{{ display }}</a></li>',f+="                        {{ /searchQueryOptions }}",f+="                    </ul>",f+="                </div>",f+="            </span>",f+='            <input type="text" class="form-control search-query"',f+='                   placeholder="Search Query"',f+='                   value="{{ searchQuery }}"/>',f+='            <span class="input-group-btn">',f+='                <a href="javascript:;"',f+='                   class="btn btn-default search-button">Search</a>',f+="            </span>",f+="        </div>",f+="    </div>",f+='    <div class="search-result"></div>',f+="</div>";var g="{{ #hasfacet_institutions }}";g+='<div class="form-group">',g+='    <label for="">Institutions</label>',g+='    <select class="form-control facet-select" data-param="institution">',g+='        <option value=""></option>',g+="        {{ #institutions_facet }}",g+='        <option value="{{ key }}">{{ key }}</option>',g+="        {{ /institutions_facet }}",g+="    </select>",g+="</div>",g+="{{ /hasfacet_institutions }}",g+="",g+="{{ #hasfacet_funders }}",g+='<div class="form-group">',g+='    <label for="">Funders</label>',g+='    <select class="form-control facet-select" data-param="funder">',g+='        <option value=""></option>',g+="        {{ #funders_facet }}",g+='        <option value="{{ key }}">{{ key }}</option>',g+="        {{ /funders_facet }}",g+="    </select>",g+="</div>",g+="{{ /hasfacet_funders }}",g+="",g+="{{ #hasfacet_activity_status }}",g+='<div class="form-group">',g+='    <label for="">Status</label>',g+='    <select class="form-control facet-select" data-param="status">',g+='        <option value=""></option>',g+="        {{ #activity_status_facet }}",g+='        <option value="{{ key }}">',g+="        {{ #titleCase }}{{ key }}{{ /titleCase }}",g+="        </option>",g+="        {{ /activity_status_facet }}",g+="    </select>",g+="</div>",g+="{{ /hasfacet_activity_status }}",g+="",g+="{{ #hasfacet_type }}",g+='<div class="form-group">',g+='    <label for="">Type</label>',g+='    <select class="form-control facet-select" data-param="type">',g+='        <option value=""></option>',g+="        {{ #type_facet }}",g+='        <option value="{{ key }}">',g+="        {{ #titleCase }}{{ key }}{{ /titleCase }}",g+="        </option>",g+="        {{ /type_facet }}",g+="    </select>",g+="</div>",g+="{{ /hasfacet_type }}",g+="",g+="{{ #hasfacet_funding_scheme }}",g+='<div class="form-group">',g+='    <label for="">Funding Scheme</label>',g+='    <select class="form-control facet-select" data-param="fundingScheme">',g+='        <option value=""></option>',g+="        {{ #funding_scheme_facet }}",g+='        <option value="{{ key }}">{{ key }}</option>',g+="        {{ /funding_scheme_facet }}",g+="    </select>",g+="</div>",g+="{{ /hasfacet_funding_scheme }}",g+="",g+="<ul>",g+="    {{ #records }}",g+="    <li>",g+='        <a href="javascript:;"',g+='           class="search-result-item"',g+='           data-purl="{{ purl }}"',g+='           data-title="{{ title }}"',g+='           data-id="{{ id }}"',g+="        >",g+="            {{ title }}",g+="        </a>",g+="    </li>",g+="    {{ /records }}",g+="</ul>",g+="",g+="<p>Displaying ({{ limit }}/{{ numFound }}) results</p>",g+="{{ #more }}",g+='<a href="javascript:;" class="show-more">Show More</a>',g+="{{ /more }}",g+="",g+="",g+="{{ ^records }}",g+="<p>No result found!</p>",g+="{{ /records }}";var h='<div class="modal fade" ';return h+='     tabindex="-1" ',h+='     role="dialog" ',h+='     aria-labelledby="searchModal" ',h+='     id="search-modal">',h+='    <div class="modal-dialog" role="document">',h+='        <div class="modal-content">',h+='            <div class="modal-header">',h+='                <button type="button" ',h+='                        class="close" ',h+='                        data-dismiss="modal" ',h+='                        aria-label="Close">',h+='                    <span aria-hidden="true">&times;</span>',h+="                </button>",h+='                <h4 class="modal-title" ',h+='                    id="gridSystemModalLabel">Search</h4>',h+="            </div>",h+='            <div class="modal-body"></div>',h+="        </div>",h+="    </div>",h+="</div>",{"display-grant-tpl":e,"search-tpl":f,"search-result-tpl":g,"search-modal":h}}(jQuery,window,document,void 0),APIService=function(a,b,c,d){"use strict";function e(b){return{lookup:function(a){return(b.mode.indexOf("activity")>-1||b.mode.indexOf("grant")>-1)&&(b.apiUrl=b.serviceUrl+"v2.0/registry.jsonp/activities"),b.apiKey&&(a.apiKey=b.apiKey),a.apiKey&&(a.api_key=a.apiKey,delete a.apiKey),this.get(b.apiUrl,a).then(function(a){return a})},get:function(b,c){return a.ajax({dataType:"jsonp",url:b,data:c}).then(function(a){return a})}}}return{create:e}}(jQuery,window,document,void 0),function(a,b,c,d){"use strict";function e(b,c){this.element=b,this.settings=a.extend(!0,{},g,c),this._defaults=g,this.params=h,this._name=f,this.init()}var f="registryWidget",g={mode:"display-activity",apiUrl:"",serviceUrl:"https://test.ands.org.au/api/",renderEngine:"default",eventPrefix:"ands.registry-widget.",searchOptions:{returnType:"purl",autoLookup:!0,searchQueryOptions:[{value:"q",display:"All"},{value:"title",display:"Title"},{value:"description",display:"Description"},{value:"researcher",display:"Researcher"},{value:"principalInvestigator",display:"Principal Investigator"},{value:"id",display:"Identifier"},{value:"subject",display:"Subject"}]}},h={apiKey:"public",facetSort:"index"};a.extend(e.prototype,{init:function(){var b=this;this.setParams(),this.service=new APIService.create(this.settings);var c=a(this.element);switch("object"==typeof Mustache&&(this.settings.renderEngine="mustache"),b.bindInternalEvents(),this.settings.mode){case"display-activity":b.lookupAndDisplay(c,"display-grant-tpl");break;case"lookup-activity":this.bindLookup(c);break;case"search-activity":this.bindSearch(c),this.bindLookup(c);break;default:this.event("error",this.settings.mode+" is not supported yet")}},bindInternalEvents:function(){var b=a(this.element),c=this;b.on(c.settings.prefix+"result-select",function(){"bootstrap-modal"===c.getSearchOption("openIn")?a("#search-modal").modal("hide"):a(".search-container").hide()}),b.on(c.settings.prefix+"error",function(a,b){console.error(b)})},bindLookup:function(b){var c,d=this;c=a(b).next(".display-target").length>0?a(b).next(".display-target")[0]:a("<div class='display-target'/>").insertAfter(b),d.lookup(b,c),a(b).on("blur",function(){d.settings.searchOptions.autoLookup&&d.lookup(b,c)}),a(b).on("keyup",function(){e(function(){d.lookup(b,c)},1e3)});var e=function(){var a=0;return function(b,c){clearTimeout(a),a=setTimeout(b,c)}}()},bindSearch:function(b){var c,d,e=this;a(b).next(".search-toggle").length>0?d=a(b).next(".search-toggle")[0]:(c="<a href='javascript:;' class='search-toggle'>Open Search</a>",d=a(c).insertAfter(b));var f;a(d).next(".search-container").length>0?f=a(d).next(".search-container")[0]:(c="<div class='search-container'></div>",f=a(c).insertAfter(d)),f.hide();var g={};this.settings.searchOptions&&this.settings.searchOptions.facets&&(g.facets=this.settings.searchOptions.facets);var h=e.settings.searchOptions.searchQueryOptions;g.searchQueryOptions=h,g.activeQueryOptionDisplay="All",g.activeQueryOptionValue="q",g.titleCase=function(){return function(a,b){return b(a)+"stuff"}},this.render(f,g,"search-tpl"),d.on("click",function(){var b=e.getSearchOption("openIn");if(b)if("bootstrap-modal"===b){var c=a("#search-modal");c.length<1&&a("body").append(e.getTemplate("search-modal")),c=a("#search-modal"),f.appendTo(a(".modal-body",c)).show(),c.modal("show")}else e.event("error",b+"mode is not supported yet");else f.toggle()});var i=a(".search-query",f),j=a(".search-button",f),k=a(".search-result",f);this.settings.searchOptions&&this.settings.searchOptions.autoSearch&&(e.search(k),f.show()),i.on("keyup",function(a){13===a.which&&e.search(k)}),j.on("click",function(){var b=a(".active-query-option",f).attr("data-value");e.params[b]=i.val(),e.search(k)}),a(".select-query-option",f).on("click",function(){var b=i,c=a(this).data("value"),d=b.val(),g="";a.each(h,function(){delete e.params[this.value],this.value===c&&(g=this.display)}),e.params[c]=d,a(".active-query-option",f).attr("data-value",c).html(g)}),a(k).on("click",".search-result-item",function(){e.event("result-select",a(this));var c=e.settings.searchOptions.returnType,d=a(this).data(c);d?(a(b).val(a(this).data(c)),a(b).blur()):e.event("error","No return value ")}),a(k).on("change",".facet-select",function(){var b=a(this).data("param");""!==a(this).val()?e.params[b]='"'+a(this).val()+'"':delete e.params[b],e.search(k)}),a(k).on("click",".show-more",function(){var a;a=e.params.pp?e.params.pp:30,e.params.limit=e.params.limit?e.params.limit+a:30+a,e.search(k)})},lookup:function(b,c){var d=this,e=d.settings.searchOptions.returnType;""!==a(b).val()&&d.params[e]!==a(b).val()&&(d.params[e]=a(b).val(),d.lookupAndDisplay(c,"display-grant-tpl"))},search:function(b){var c=this;delete c.params.purl;var e=a(c.element).nextAll(".search-container"),f=a(".search-query",e),g=a(".active-query-option",e).attr("data-value");""!==g&&g!==d||(g="q"),c.params[g]=f.val(),c.event("pre-search",[c.settings,c.params]),c.lookupAndDisplay(b,"search-result-tpl")},getSearchOption:function(a){return this.settings.searchOptions&&this.settings.searchOptions[a]?this.settings.searchOptions[a]:!1},lookupAndDisplay:function(b,c){var d=this;""===a(b).text()&&a(b).text("Loading..."),d.getSearchOption("facets")!==!1&&(d.params.facets=d.getSearchOption("facets").join()),d.getSearchOption("facetSort")!==!1&&(d.params.facetSort=d.getSearchOption("facetSort")),d.service.lookup(d.params).done(function(a){d.event("search-complete",a),d.render(b,a,c)})},setParams:function(){this.params=a.extend({},this.params,a(this.element).data()),this.getSearchOption("params")&&(this.params=a.extend({},this.params,this.getSearchOption("params")))},render:function(b,c,d){var e=this;"default"===this.settings.renderEngine?a(b).text(JSON.stringify(c)):"mustache"===this.settings.renderEngine?(d=e.getTemplate(d),c=e.preProcessContent(c),e.event("pre-render",[b,c,d]),a(b).html(Mustache.render(d,c)),e.postProcessContent(b),e.event("post-render",[b,c,d])):e.event("error","No rendering engine found"),e.event("render-complete",[b,c,d])},preProcessContent:function(b){return b.numFound&&(b.more=b.limit<b.numFound),b.facets&&a.each(b.facets,function(a,c){b[a+"_facet"]=c,b["hasfacet_"+a]=!0,b.titleCase=function(){return function(a,b){return b(a).replace(/\w\S*/g,function(a){return a.charAt(0).toUpperCase()+a.substr(1).toLowerCase()})}}}),b},postProcessContent:function(b){var c=this;a.each(a("select",b),function(){var b=a(this).data("param");c.params[b]&&a(this).val(c.params[b].replace(/["]+/g,""))})},event:function(b,c){var d=this.settings.eventPrefix;a(this.element).trigger(d+b,c)},getTemplate:function(b){var c="",d=a("#"+b);return d.length>0?c=d.html():defaultTemplates[b]&&(c=defaultTemplates[b]),""===c&&(this.event("error","No template found: "+b),c="No template found"),c}}),a.fn[f]=function(b){return this.each(function(){a.data(this,"plugin_"+f)||a.data(this,"plugin_"+f,new e(this,b))})}}(jQuery,window,document,APIService,defaultTemplates);