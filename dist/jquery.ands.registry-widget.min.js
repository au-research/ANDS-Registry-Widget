/*
 *  ANDS-Registry-Widget - v0.0.1
 *  A Widget to display and search for ANDS Registry contents
 *  https://developers.ands.org.au/
 *
 *  Made by Minh Duc Nguyen
 *  Under MIT License
 */
defaultTemplates=function(a,b,c,d){"use strict";var e='<div class="well">';e+="        {{ #recordData }}",e+="        <h4>{{title}}</h4>",e+="        <dl>",e+="            {{ #purl }}",e+="            <dt>PURL</dt>",e+="            <dd>{{ purl }}</dd>",e+="            {{ /purl }}",e+="            {{ #institutions }}",e+="            <dt>Institutions</dt>",e+="            <dd>{{ institutions }}</dd>",e+="            {{ /institutions }}",e+="            {{ #funder }}",e+="            <dt>Funder</dt>",e+="            <dd>{{ funder }}</dd>",e+="            {{ /funder }}",e+="            {{ #fundingScheme }}",e+="            <dt>Funding Scheme</dt>",e+="            <dd>{{ fundingScheme }}</dd>",e+="            {{ /fundingScheme }}",e+="            {{ #researchers }}",e+="            <dt>Researchers</dt>",e+="            <dd>{{ researchers }}</dd>",e+="            {{ /researchers }}",e+="        </dl>",e+="        {{ description }}",e+="        {{ /recordData }}",e+="        {{ ^recordData }}",e+="        <p>No result found!</p>",e+="        {{ /recordData}}",e+="    </div>";var f='<div class="well">';f+='    <div class="form-group">',f+='        <label for="lookup-grant">Search Query</label>',f+="",f+='        <div class="input-group">',f+='            <span class="input-group-btn">',f+='                <div class="btn-group">',f+='                    <button type="button"',f+='class="btn btn-default dropdown-toggle btn-select-query-option"',f+='data-toggle="dropdown" aria-haspopup="true"',f+='                            aria-expanded="false">',f+='                        <span class="value active-query-option"',f+='                              data-value="{{ activeQueryOptionValue }}">',f+="                            {{ activeQueryOptionDisplay }}",f+="                        </span>",f+='                        <span class="caret"></span>',f+="                    </button>",f+='                    <ul class="dropdown-menu">',f+="                        {{ #searchQueryOptions }}",f+='                            <li><a href="javascript:;"',f+='                   class="select-query-option"',f+='                   data-value="{{ value }}">{{ display }}</a></li>',f+="                        {{ /searchQueryOptions }}",f+="                    </ul>",f+="                </div>",f+="            </span>",f+='            <input type="text" class="form-control search-query"',f+='                   placeholder="Search Query"',f+='                   value="{{ searchQuery }}"/>',f+='            <span class="input-group-btn">',f+='                <a href="javascript:;"',f+='                   class="btn btn-default search-button">Search</a>',f+="            </span>",f+="        </div>",f+="    </div>",f+='    <div class="search-result"></div>',f+="</div>";var g="{{ #hasfacet_administering_institution }}";return g+='<div class="form-group">',g+='    <label for="">Institutions</label>',g+='    <select class="form-control facet-select" data-param="institution">',g+='        <option value=""></option>',g+="        {{ #administering_institution_facet }}",g+='        <option value="{{ key }}">{{ key }}</option>',g+="        {{ /administering_institution_facet }}",g+="    </select>",g+="</div>",g+="{{ /hasfacet_administering_institution }}",g+="",g+="{{ #hasfacet_funders }}",g+='<div class="form-group">',g+='    <label for="">Funders</label>',g+='    <select class="form-control facet-select" data-param="funder">',g+='        <option value=""></option>',g+="        {{ #funders_facet }}",g+='        <option value="{{ key }}">{{ key }}</option>',g+="        {{ /funders_facet }}",g+="    </select>",g+="</div>",g+="{{ /hasfacet_funders }}",g+="",g+="{{ #hasfacet_type }}",g+='<div class="form-group">',g+='    <label for="">Type</label>',g+='    <select class="form-control facet-select" data-param="type">',g+='        <option value=""></option>',g+="        {{ #type_facet }}",g+='        <option value="{{ key }}">{{ key }}</option>',g+="        {{ /type_facet }}",g+="    </select>",g+="</div>",g+="{{ /hasfacet_type }}",g+="",g+="{{ #hasfacet_funding_scheme }}",g+='<div class="form-group">',g+='    <label for="">Funding Scheme</label>',g+='    <select class="form-control facet-select" data-param="fundingScheme">',g+='        <option value=""></option>',g+="        {{ #funding_scheme_facet }}",g+='        <option value="{{ key }}">{{ key }}</option>',g+="        {{ /funding_scheme_facet }}",g+="    </select>",g+="</div>",g+="{{ /hasfacet_funding_scheme }}",g+="",g+="<ul>",g+="    {{ #recordData }}",g+="    <li>",g+='        <a href="javascript:;"',g+='           class="search-result-item"',g+='           data-purl="{{ purl }}"',g+="        >",g+="            {{ title }}",g+="        </a>",g+="    </li>",g+="    {{ /recordData }}",g+="</ul>",g+="",g+="<p>Displaying ({{ numFound }}/{{ totalFound }}) results</p>",g+="{{ #more }}",g+='<a href="javascript:;" class="show-more">Show More</a>',g+="{{ /more }}",g+="",g+="",g+="{{ ^recordData }}",g+="<p>No result found!</p>",g+="{{ /recordData }}",{"display-grant-tpl":e,"search-tpl":f,"search-result-tpl":g}}(jQuery,window,document,void 0),APIService=function(a,b,c,d){"use strict";function e(b){return{lookup:function(a){return this.get(b.apiUrl,a).then(function(a){return a})},get:function(b,c){return a.ajax({dataType:"jsonp",url:b,data:c}).then(function(a){return a})}}}return{create:e}}(jQuery,window,document,void 0),function(a,b,c,d){"use strict";function e(b,c){this.element=b,this.settings=a.extend({},g,c),this._defaults=g,this.params=h,this._name=f,this.init()}var f="registryWidget",g={mode:"display-grant",apiUrl:"",serviceUrl:"http://devl.ands.org.au/minh/api/",renderEngine:"default"},h={apiKey:"public"};a.extend(e.prototype,{init:function(){this.setParams(),this.service=new APIService.create(this.settings);var b=a(this.element),c=this;switch("object"==typeof Mustache&&(this.settings.renderEngine="mustache"),this.settings.mode){case"display-grant":c.lookupAndDisplay(b,"display-grant-tpl");break;case"lookup-grant":this.bindLookup(b);break;case"search-grant":this.bindSearch(b),this.bindLookup(b)}},bindLookup:function(b){var c,d=this;c=a(b).next(".display-target").length>0?a(b).next(".display-target")[0]:a("<div class='display-target'/>").insertAfter(b),d.lookup(b,c),a(b).on("blur",function(){d.lookup(b,c)}),a(b).on("keyup",function(){e(function(){d.lookup(b,c)},1e3)});var e=function(){var a=0;return function(b,c){clearTimeout(a),a=setTimeout(b,c)}}()},bindSearch:function(b){var c,d,e=this;a(b).next(".search-toggle").length>0?d=a(b).next(".search-toggle")[0]:(c="<a href='javascript:;' class='search-toggle'>Open Search</a>",d=a(c).insertAfter(b));var f;a(d).next(".search-container").length>0?f=a(d).next(".search-container")[0]:(c="<div class='search-container'></div>",f=a(c).insertAfter(d)),f.hide();var g={};this.settings.searchOptions&&this.settings.searchOptions.facets&&(g.facets=this.settings.searchOptions.facets);var h=[{value:"q",display:"All"},{value:"title",display:"Title"},{value:"description",display:"Description"},{value:"person",display:"Person"},{value:"id",display:"Identifier"}];g.searchQueryOptions=h,g.activeQueryOptionDisplay="All",g.activeQueryOptionValue="q",this.render(f,g,"search-tpl"),d.on("click",function(){f.toggle()});var i=a(".search-query",f),j=a(".search-button",f),k=a(".search-result",f);this.settings.searchOptions&&this.settings.searchOptions.autoSearch&&(e.search(k),f.show()),i.on("keyup",function(a){13===a.which&&e.search(k)}),j.on("click",function(){e.search(k)}),a(".select-query-option",f).on("click",function(){var b=i,c=a(this).data("value"),d=b.val(),g="";a.each(h,function(){delete e.params[this.value],this.value===c&&(g=this.display)}),e.params[c]=d,a(".active-query-option",f).attr("data-value",c).html(g)}),a(k).on("click",".search-result-item",function(){a(b).val(a(this).data("purl")),a(f).hide(),a(b).blur()}),a(k).on("change",".facet-select",function(){var b=a(this).data("param");e.params[b]=a(this).val(),e.search(k)}),a(k).on("click",".show-more",function(){var a;a=e.params.pp?e.params.pp:30,e.params.rows=e.params.rows?e.params.rows+a:30+a,e.search(k)})},lookup:function(b,c){var d=this;""!==a(b).val()&&d.params.purl!==a(b).val()&&(d.params.purl=a(b).val(),d.lookupAndDisplay(c,"display-grant-tpl"))},search:function(b){var c=this;delete c.params.purl;var e=a(c.element).nextAll(".search-container"),f=a(".search-query",e),g=a(".active-query-option",e).attr("data-value");""!==g&&g!==d||(g="q"),c.params[g]=f.val(),c.lookupAndDisplay(b,"search-result-tpl")},getSearchOption:function(a){return this.settings.searchOptions&&this.settings.searchOptions[a]?this.settings.searchOptions[a]:!1},lookupAndDisplay:function(b,c){var d=this;""===a(b).text()&&a(b).text("Loading..."),d.getSearchOption("facets")!==!1&&(d.params.facets=d.getSearchOption("facets").join()),d.service.lookup(d.params).done(function(a){d.event("search-complete",a),d.render(b,a,c)})},setParams:function(){this.settings.mode.indexOf("grant")>-1&&(this.settings.apiUrl=this.settings.serviceUrl+"v2.0/registry.jsonp/grants"),this.settings.apiKey&&(this.params.apiKey=this.settings.apiKey),this.params=a.extend({},this.params,a(this.element).data()),this.getSearchOption("params")&&(this.params=a.extend({},this.params,this.getSearchOption("params")))},render:function(b,c,d){var e=this;"default"===this.settings.renderEngine?a(b).text(JSON.stringify(c)):"mustache"===this.settings.renderEngine?(d=e.getTemplate(d),c.numFound&&c.totalFound&&(c.more=c.numFound<c.totalFound),c.facets&&a.each(c.facets,function(a,b){c[a+"_facet"]=b,c["hasfacet_"+a]=!0}),a(b).html(Mustache.render(d,c)),a.each(a("select",b),function(){var b=a(this).data("param");e.params[b]&&a(this).val(e.params[b])})):e.event("error","No rendering engine found"),e.event("render-complete",[b,c,d])},event:function(b,c){var d="ands.registry-widget.";a(this.element).trigger(d+b,c)},getTemplate:function(b){var c="No template found!",d=a("#"+b);return d.length>0?c=d.html():defaultTemplates[b]&&(c=defaultTemplates[b]),c}}),a.fn[f]=function(b){return this.each(function(){a.data(this,"plugin_"+f)||a.data(this,"plugin_"+f,new e(this,b))})}}(jQuery,window,document,APIService,defaultTemplates);